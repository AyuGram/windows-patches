Subject: [PATCH] feat: implement keepMessagesHistory
---
Index: Telegram/SourceFiles/data/data_session.cpp
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/Telegram/SourceFiles/data/data_session.cpp b/Telegram/SourceFiles/data/data_session.cpp
--- a/Telegram/SourceFiles/data/data_session.cpp	(revision 57c01bbfb18ce0a63fe86d7e998f4a9ad7356915)
+++ b/Telegram/SourceFiles/data/data_session.cpp	(date 1683200224130)
@@ -2172,6 +2172,31 @@
 		Reactions::CheckUnknownForUnread(this, data);
 		return;
 	}
+
+    // AyuGram keepMessagesHistory
+    const auto settings = &Core::App().settings();
+    if (settings->keepMessagesHistory() && data.c_message().vmessage().v != existing->originalText().text) {
+        const auto history = existing->history();
+        const auto msg = existing->originalText();
+
+        const auto media = MTP_messageMediaEmpty(); // todo: save media
+
+        history->addNewLocalMessage(
+                history->nextNonHistoryEntryId(),
+                MessageFlag::HasFromId
+                | MessageFlag::HasReplyInfo
+                | MessageFlag::HasPostAuthor,
+                UserId(),
+                existing->id,
+                base::unixtime::now(),
+                existing->author()->id,
+                "AyuGram",
+                msg,
+                media,
+                HistoryMessageMarkupData(),
+                existing->groupId().empty() ? 0 : existing->groupId().value);
+    }
+
 	if (existing->isLocalUpdateMedia() && data.type() == mtpc_message) {
 		updateExistingMessage(data.c_message());
 	}
